<!DOCTYPE html -->
<html>
<head>
  <title>Vector tiles</title>
  <script src="http://localhost:8080/openlayers3/ol.js" type="text/javascript"></script>
  <link rel="stylesheet" href="http://localhost:8080/openlayers3/ol.css" type="text/css">
  <style>
    html, body {
      font-family: sans-serif;
      width: 100%;
    }
    .map {
      height: 500px;
      width: 100%;
    }
  </style>
</head>
<body>
  <h3>Mapbox Protobuf - vector tiles</h3>
  <div id="map" class="map"></div>
  <div id="wrapper">
    <div id="location"></div>
  </div>
  <div id="nodelist">
    <em>Click on the map to get feature info</em>
  </div>
  <script>

  var style_simple = new ol.style.Style({
    // fill: new ol.style.Fill({
    //   color: 'rgba(0, 0, 0, 0)'
    // }),
    stroke: new ol.style.Stroke({
      color: '#00AAFF',
      width: 0.1
    })
  });

  var style_selected = new ol.style.Style({
    fill: new ol.style.Fill({
      color: 'rgba(255,255,255,0.1)'
    }),
    stroke: new ol.style.Stroke({
      color: '#FFAA00',
      width: 1
    })
  });

  var mousePositionControl = new ol.control.MousePosition({
          className: 'custom-mouse-position',
          target: document.getElementById('location'),
          coordinateFormat: ol.coordinate.createStringXY(5),
          undefinedHTML: '&nbsp;'
        });

  // function simpleStyle(feature) {
  //   return style_simple;
  // }

  // var layer = 'opengeo:countries';
  // var layer = 'mercury:H05_surface_features';
  var projection_epsg_no = '900913';
  var format = 'image/png';
  var bounds = [-7664543.596963018, -10133207.06495813,
                7664445.871936496, 10133306.707830522];

  var _projection = new ol.proj.Projection({
    code: 'bla',
    units: 'm',
    extent: [-7663601.119166941, -3831800.559566609,
              7663601.119133218, 3831800.5595834707]
  })

  var raster_global = new ol.layer.Tile({
    source: new ol.source.TileWMS({
      url: 'http://localhost:8080/mercury/wms',
      params: {LAYERS: 'mercury:mercury_global_MD3Color_665m_EPSG4326'}
    })
  });

  var raster_geounits_3 = new ol.layer.Tile({
    visible: true,
    opacity: 0.5,
    source: new ol.source.TileWMS({
      url: 'http://localhost:8080/mercury/wms',
      params: {'FORMAT': format,
               'VERSION': '1.1.1',
               tiled: true,
            "LAYERS": 'mercury:H05_geological_units_3_classes_EPSG4326',
            "exceptions": 'application/vnd.ogc.se_inimage',
         // tilesOrigin: -0.0000000040573446 + "," + 22.49999999818148
      }
    })
  });
  // raster_geounits_3.setZIndex(3);

  var vector_geounits_3_src = new ol.source.Vector({
    format: new ol.format.GeoJSON(),
    url: function(extent) {
      return 'http://localhost:8080/wfs?' +
          'service=WFS&version=1.1.0&request=GetFeature&' +
          'typename=mercury:H05_geological_units_3_classes_EPSG4326&' +
          'outputFormat=application/json&' +
          'srsname=EPSG:4326&' +
          'bbox=' + extent.join(',');
    },
    strategy: ol.loadingstrategy.bbox,
    crossOrigin: null
  });

  var vector_geounits_3 = new ol.layer.Vector({
    source: vector_geounits_3_src,
    style: style_simple
  });
  // vector_geounits_3.setZIndex(1);

  var map = new ol.Map({
    target: 'map',
    view: new ol.View({
      projection: 'EPSG:4326',
      center: [0, 0],
      zoom: 2
    }),
    controls: ol.control.defaults().extend([mousePositionControl]),
    // layers: [new ol.layer.VectorTile({
    //   style:simpleStyle,
    //   source: new ol.source.VectorTile({
    //     tilePixelRatio: 1, // oversampling when > 1
    //     tileGrid: ol.tilegrid.createXYZ({maxZoom: 19}),
    //     format: new ol.format.MVT(),
    //     url: '/geoserver/gwc/service/tms/1.0.0/' + layer +
    //         '@EPSG%3A'+projection_epsg_no+'@pbf/{z}/{x}/{-y}.pbf'
    //   })
    // })]
    layers: [
      // new ol.layer.Tile({
      //   source: new ol.source.XYZ({
      //     url: "http://localhost:8080/gwc/service/tms/1.0.0/" +
      //           "mercury:mercury_global_color_665m_EPSG4326@EPSG:4326@jpeg/{z}/{x}/{-y}.jpg",
      //   })
      // }),
      raster_global,
      // new ol.layer.Vector({
      //   source: new ol.source.Vector({
      //     format: new ol.format.GeoJSON(),
      //     url: function(extent) {
      //       return 'http://localhost:8080/wfs?' +
      //           'service=WFS&version=1.1.0&request=GetFeature&' +
      //           'outputFormat=application/json&' +
      //           'typename=mercury:H05_contacts_EPSG4326&' +
      //           // 'outputFormat=application/json&srsname=EPSG:4326&' +
      //           'bbox=' + extent.join(',');
      //     },
      //     strategy: ol.loadingstrategy.bbox,
      //     crossOrigin: null
      //   }),
      //   style: style_simple
      // }),
      raster_geounits_3,
      vector_geounits_3,
      // new ol.layer.Vector({
      //   source: new ol.source.Vector({
      //     format: new ol.format.GeoJSON(),
      //     url: function(extent) {
      //       return 'http://localhost:8080/wfs?' +
      //           'service=WFS&version=1.1.0&request=GetFeature&' +
      //           // 'outputFormat=application/json&' +
      //           'typename=mercury:H05_geological_units_5_classes_EPSG4326&' +
      //           'outputFormat=application/json&srsname=EPSG:4326&' +
      //           'bbox=' + extent.join(',');
      //     },
      //     strategy: ol.loadingstrategy.bbox,
      //     crossOrigin: null
      //   }),
      //   style: style_simple
      // }),
      // new ol.layer.Vector({
      //   source: new ol.source.Vector({
      //     format: new ol.format.GeoJSON(),
      //     url: function(extent) {
      //       return 'http://localhost:8080/wfs?' +
      //           'service=WFS&version=1.1.0&request=GetFeature&' +
      //           'typename=	mercury:H05_linear_features_EPSG4326&' +
      //           'outputFormat=application/json&' +
      //           'srsname=EPSG:4326&' +
      //           'bbox=' + extent.join(',');
      //     },
      //     strategy: ol.loadingstrategy.bbox,
      //     crossOrigin: null
      //   }),
      //   style: style_simple
      // }),
      // new ol.layer.Vector({
      //   source: new ol.source.Vector({
      //     format: new ol.format.GeoJSON(),
      //     url: function(extent) {
      //       return 'http://localhost:8080/wfs?' +
      //           'service=WFS&version=1.1.0&request=GetFeature&' +
      //           'typename=	mercury:H05_surface_features_EPSG4326&' +
      //           'outputFormat=application/json&' +
      //           'srsname=EPSG:4326&' +
      //           'bbox=' + extent.join(',');
      //     },
      //     strategy: ol.loadingstrategy.bbox,
      //     crossOrigin: null
      //   }),
      //   style: style_simple
      // }),
  //
  // var vector = new ol.layer.Vector({
  //   source: vectorSource,
  //   style: new ol.style.Style({
  //     stroke: new ol.style.Stroke({
  //       color: 'rgba(0, 0, 255, 1.0)',
  //       width: 2
  //     })
  //   })
  // });
      // new ol.layer.Tile({
      //   visible: false,
      //   source: new ol.source.TileWMS({
      //     url: 'http://localhost:8080/mercury/wms',
      //     params: {'FORMAT': format,
      //              'VERSION': '1.1.1',
      //              tiled: true,
      //           "LAYERS": 'mercury:Mercury_MESSENGER_MDIS_Basemap_BDR_Mosaic_Global_166m-WEB_MERCATOR',
      //           "exceptions": 'application/vnd.ogc.se_inimage',
      //        tilesOrigin: 0 + "," + 0
      //     }
      //   })
      // }),
    ]
  });

  map.on('singleclick', function(evt) {
    document.getElementById('nodelist').innerHTML = "Loading... please wait...";
    var view = map.getView();
    var viewResolution = view.getResolution();
    var source = raster_geounits_3.getSource();
    var url = source.getGetFeatureInfoUrl(
      evt.coordinate, viewResolution, view.getProjection(),
      {'INFO_FORMAT': 'text/html', 'FEATURE_COUNT': 50});
    if (url) {
      var xhr = new XMLHttpRequest();
      xhr.onload = function() {
        document.getElementById('nodelist').innerHTML = this.responseText;
        // console.log(this.responseXML);
        // console.log(this.responseText);
      }
      xhr.open("GET", url);
      // xhr.responseType = "document";
      xhr.send();
    }
  });

  // a normal select interaction to handle click
  var select = new ol.interaction.Select({style: style_selected});
  map.addInteraction(select);

  var selectedFeatures = select.getFeatures();

  // a DragBox interaction used to select features by drawing boxes
  var dragBox = new ol.interaction.DragBox({
    condition: ol.events.condition.platformModifierKeyOnly
  });

  map.addInteraction(dragBox);

  dragBox.on('boxend', function() {
    // features that intersect the box are added to the collection of
    // selected features
    var extent = dragBox.getGeometry().getExtent();
    // vector_geounits_3_src.forEachFeatureIntersectingExtent(extent, function(feature) {
    vector_geounits_3_src.forEachFeatureInExtent(extent, function(feature) {
      // feature.setStyle(style_selected);
      // feature.setZIndex(1);
      selectedFeatures.push(feature);
    });
  });

  // clear selection when drawing a new box and when clicking on the map
  dragBox.on('boxstart', function() {
    selectedFeatures.clear();
  });


  // var xhr = new XMLHttpRequest();
  // xhr.open("POST", "http://localhost:8080/wfs", true);
  // var params = 'service=WFS&version=1.1.0&request=GetFeature&outputFormat=application/json&typename=mercury:H05_surface_features-WEB_MERCATOR';
  // xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
  // xhr.onreadystatechange = function() { // Call a function when the state changes.
  //   if (this.readyState === XMLHttpRequest.DONE && this.status === 200) {
  //     console.log(xhr.responseText);
  //   }
  // }
  // xhr.send(params);
  </script>
</body>
<!-- Useful references:
* Box features selection: https://openlayers.org/en/latest/examples/box-selection.html
* Single/Multi features selection: https://openlayers.org/en/latest/examples/vector-tile-selection.html
* Single/Multi/Hover selection: https://openlayers.org/en/latest/examples/select-features.html
* Regular shape styles: https://openlayers.org/en/latest/examples/regularshape.html
* Polygon styling: https://openlayers.org/en/latest/examples/polygon-styles.html
* Clustering markers: https://openlayers.org/en/latest/examples/earthquake-clusters.html
* Query WFS features: https://openlayers.org/en/latest/examples/vector-wfs-getfeature.html
-->
</html>
